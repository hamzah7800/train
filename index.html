<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><title>Train Coâ€‘op Multiplayer</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>/* ... your existing CSS ... */
#mpUI {position:absolute;top:10px;right:10px;background:#000a;color:#fff;padding:10px;border-radius:6px;font-family:sans-serif;}
#mpUI input, #mpUI button {display:block;width:100%;margin:6px 0;}</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<!-- existing UI: joystick, buttons, HUD, etc. -->
<div id="mpUI">
  <button id="btnHost">Create Game</button>
  <button id="btnJoin">Join Game</button>
  <div id="hostPanel" style="display:none">
    <p>Code to share:</p><input id="roomCode" readonly>
    <p>Paste answer from player 2:</p><textarea id="answerInput"></textarea>
    <button id="btnAccept">Connect</button>
  </div>
  <div id="joinPanel" style="display:none">
    <p>Enter room code:</p><input id="joinCode">
    <button id="btnLookup">Lookup</button>
    <p>Your answer:</p><textarea id="myAnswer" readonly></textarea>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
const peerOptions = { initiator: false, trickle: false };
let peer, isHost = false;
let hostOffer = null;

// Simple in-browser map: roomCode -> offer
const roomOffers = {};

function toCode(json) {
  const hash = btoa(json).replace(/[+/=]/g, '').slice(0,5);
  return hash.toUpperCase();
}
function encode(obj) { return JSON.stringify(obj); }
function decode(str) { try { return JSON.parse(str); } catch { return null; } }

// Host flow
document.getElementById("btnHost").onclick = () => {
  peer = new SimplePeer({ initiator: true, trickle: false });
  peer.on('signal', data => {
    const offerStr = encode(data);
    const code = toCode(offerStr);
    hostOffer = offerStr;
    roomOffers[code] = offerStr;
    document.getElementById("roomCode").value = code;
    document.getElementById("hostPanel").style.display = 'block';
  });
  peer.on('connect', onConnect);
};

// Join flow
document.getElementById("btnJoin").onclick = () => {
  document.getElementById("joinPanel").style.display = 'block';
};
document.getElementById("btnLookup").onclick = () => {
  const code = document.getElementById("joinCode").value.trim().toUpperCase();
  const offerStr = roomOffers[code];
  if (!offerStr) return alert("Invalid code");
  const offer = decode(offerStr);
  peer = new SimplePeer(peerOptions);
  peer.on('signal', ans => {
    document.getElementById("myAnswer").value = encode(ans);
  });
  peer.on('connect', onConnect);
  peer.signal(offer);
};

// Host receives answer
document.getElementById("btnAccept").onclick = () => {
  const ans = decode(document.getElementById("answerInput").value);
  if (!ans) return alert("Invalid JSON");
  peer.signal(ans);
};

// Once connected
function onConnect() {
  console.log("Connected!");
  isHost = !!hostOffer;
  // initialize game state and start game loop here...
  startGame();
}

// message sync example
peer.on('data', d => {
  const msg = JSON.parse(d);
  if (msg.type === 'state') {
    // host sends full game state
    if (!isHost) applyState(msg.data);
  }
});

function sendState(state) {
  if (peer && peer.connected) {
    peer.send(JSON.stringify({ type:'state', data:state }));
  }
}

// In your game loop (if host):
if (isHost && peer.connected) sendState({
  wave, enemies, bullets, trainState:train
});

// In your game loop, apply peer movement inputs accordingly...

</script>
</body>
</html>
