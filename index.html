<!DOCTYPE html>
<html>
<head>
  <title>Train Defense Co-op</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #222;
    }
    canvas {
      display: block;
      background: #228B22;
      touch-action: none;
    }
    #multiplayer {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-family: sans-serif;
      z-index: 10;
    }
    textarea {
      width: 100%;
      height: 50px;
      font-family: monospace;
    }
    button {
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="multiplayer">
    <div><b>Multiplayer</b></div>
    <button onclick="createGame()">Create Game</button>
    <button onclick="joinGame()">Join Game</button>
    <div id="hostBox" style="display:none;">
      <p>Share this code:</p>
      <textarea id="hostCode"></textarea>
      <p>Paste their response:</p>
      <textarea id="peerAnswer"></textarea>
      <button onclick="receiveAnswer()">Connect</button>
    </div>
    <div id="joinBox" style="display:none;">
      <p>Paste host code:</p>
      <textarea id="joinCode"></textarea>
      <button onclick="sendAnswer()">Send & Connect</button>
      <p>Your response:</p>
      <textarea id="joinResponse"></textarea>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let bullets = [];
    let enemies = [];
    let level = 1;
    let waveInProgress = false;
    let playerId = 1; // default: host is player1
    let connected = false;
    let peer;

    const player1 = { x: 100, y: 200, vx: 0, vy: 0, coins: 0, bullets: 64, canShoot: true, health: 5 };
    const player2 = { x: 100, y: 300, vx: 0, vy: 0, coins: 0, bullets: 64, canShoot: true, health: 5 };

    function startWave() {
      if (waveInProgress) return;
      waveInProgress = true;
      let count = 3 + level * 2;
      for (let i = 0; i < count; i++) {
        setTimeout(() => {
          enemies.push({ x: canvas.width, y: Math.random() * canvas.height, hp: 2 + level, speed: 1 + level * 0.1 });
        }, i * 800);
      }
    }

    function drawPlayer(p, color) {
      ctx.fillStyle = color;
      ctx.fillRect(p.x, p.y, 30, 20);
    }

    function shoot(player) {
      if (!player.canShoot || player.bullets <= 0) return;
      bullets.push({ x: player.x + 30, y: player.y + 10, vx: 6, owner: playerId });
      player.bullets--;
      player.canShoot = false;
      setTimeout(() => player.canShoot = true, 1000);
    }

    function reload(player) {
      player.bullets = 64;
    }

    function update() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#228B22";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Move players
      [player1, player2].forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
      });

      drawPlayer(player1, "blue");
      drawPlayer(player2, "orange");

      // Bullets
      ctx.fillStyle = "yellow";
      bullets.forEach((b, i) => {
        b.x += b.vx;
        ctx.fillRect(b.x, b.y, 5, 2);
        if (b.x > canvas.width) bullets.splice(i, 1);
      });

      // Enemies
      enemies.forEach((e, i) => {
        e.x -= e.speed;
        ctx.fillStyle = "red";
        ctx.fillRect(e.x, e.y, 20, 20);
        bullets.forEach((b, j) => {
          if (Math.hypot(b.x - e.x, b.y - e.y) < 15) {
            e.hp--;
            bullets.splice(j, 1);
          }
        });
        if (e.hp <= 0) {
          player1.coins++;
          enemies.splice(i, 1);
        }
      });

      // UI
      ctx.fillStyle = "white";
      ctx.font = "16px sans-serif";
      ctx.fillText("Level: " + level, 10, 20);
      ctx.fillText("P1 Bullets: " + player1.bullets, 10, 40);
      ctx.fillText("P2 Bullets: " + player2.bullets, 10, 60);
      ctx.fillText("Coins: " + player1.coins, 10, 80);

      // Multiplayer state
      if (connected && playerId === 1) {
        const gameState = {
          player1, player2, bullets, enemies, level
        };
        peer.send(JSON.stringify({ type: "sync", data: gameState }));
      }

      requestAnimationFrame(update);
    }

    // SimplePeer setup
    function createGame() {
      playerId = 1;
      peer = new SimplePeer({ initiator: true, trickle: false });
      peer.on("signal", data => {
        document.getElementById("hostBox").style.display = "block";
        document.getElementById("hostCode").value = JSON.stringify(data);
      });
      peer.on("connect", () => {
        connected = true;
        console.log("Connected as host");
        startWave();
      });
      peer.on("data", handlePeerMessage);
    }

    function receiveAnswer() {
      const answer = JSON.parse(document.getElementById("peerAnswer").value);
      peer.signal(answer);
    }

    function joinGame() {
      playerId = 2;
      peer = new SimplePeer({ initiator: false, trickle: false });
      peer.on("signal", data => {
        document.getElementById("joinBox").style.display = "block";
        document.getElementById("joinResponse").value = JSON.stringify(data);
      });
      peer.on("connect", () => {
        connected = true;
        console.log("Connected as client");
      });
      peer.on("data", msg => {
        const { type, data } = JSON.parse(msg);
        if (type === "sync") {
          Object.assign(player1, data.player1);
          Object.assign(player2, data.player2);
          bullets = data.bullets;
          enemies = data.enemies;
          level = data.level;
        }
      });
    }

    function sendAnswer() {
      const offer = JSON.parse(document.getElementById("joinCode").value);
      peer.signal(offer);
    }

    function handlePeerMessage(msg) {
      const { type, data } = JSON.parse(msg);
      if (type === "input") {
        Object.assign(player2, data);
      }
    }

    // Touch controls
    const joystick = {
      baseX: 80,
      baseY: canvas.height - 80,
      radius: 40,
      stickX: 80,
      stickY: canvas.height - 80,
      active: false
    };

    canvas.addEventListener("touchstart", e => {
      for (let t of e.touches) {
        let dx = t.clientX - joystick.baseX;
        let dy = t.clientY - joystick.baseY;
        if (Math.hypot(dx, dy) < joystick.radius + 30) {
          joystick.active = true;
          joystick.stickX = t.clientX;
          joystick.stickY = t.clientY;
        }

        if (t.clientX > canvas.width - 120 && t.clientY > canvas.height - 60) shoot(playerId === 1 ? player1 : player2);
        if (t.clientX > canvas.width - 120 && t.clientY > canvas.height - 30) reload(playerId === 1 ? player1 : player2);
      }
    });

    canvas.addEventListener("touchmove", e => {
      if (!joystick.active) return;
      let t = e.touches[0];
      joystick.stickX = t.clientX;
      joystick.stickY = t.clientY;

      let dx = joystick.stickX - joystick.baseX;
      let dy = joystick.stickY - joystick.baseY;
      let dist = Math.min(Math.hypot(dx, dy), joystick.radius);
      let angle = Math.atan2(dy, dx);

      let p = playerId === 1 ? player1 : player2;
      p.vx = Math.cos(angle) * (dist / joystick.radius) * 2;
      p.vy = Math.sin(angle) * (dist / joystick.radius) * 2;

      if (playerId === 2 && connected) {
        peer.send(JSON.stringify({ type: "input", data: p }));
      }
    });

    canvas.addEventListener("touchend", () => {
      joystick.active = false;
      joystick.stickX = joystick.baseX;
      joystick.stickY = joystick.baseY;
      let p = playerId === 1 ? player1 : player2;
      p.vx = 0;
      p.vy = 0;
    });

    update();
  </script>
</body>
</html>
